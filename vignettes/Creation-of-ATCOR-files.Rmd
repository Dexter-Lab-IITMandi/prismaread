---
title: "Creation of ATCOR files"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
### Creation of ATCOR files

When working on L1 data, the `convert_prisma` function also allows automatic creation of text files required to run 
an atmospheric correction using ATCOR. Those files are saved in the "ATCOR" subfolder of the
main output folder. 

In "standard" behaviour, only the three "standard" ATCOR files (`.wvl`, `.dat` and `.cal`) are created,
within the "ATCOR" subfolder of the main output folder, with the `.wvl` file containing nominal wavelengths and FWHMs derived from the `cw` and `fwhm` attributes of the _.he5_ file. 

For example, this code: 

```{r atcor1, eval=FALSE}
in_file  = "/home/lb/tmp/test/PRS_L1_STD_OFFL_20190825103112_20190825103117_0001.he5"
out_folder = "/home/lb/tmp/test/"
out_format = "ENVI"

# Save a full image, prioritizing the VNIR spectrometer and save in EVI format
convert_prisma(in_file    = in_file,
               out_file   = out_folder,
               out_format = out_format,
               join_priority = "VNIR", 
               ATCOR = TRUE, 
               FULL = TRUE,
               PAN  = TRUE,
               CLOUD  = TRUE)

```

will create input files for ATCOR useful for correction of the full hyperspectral cube. 

The user can however also choose to generate additional ATCOR files, containing data about
wavelengths and FWHMs related to different "columns" of the data cube, as derived 
from the `KDP_AUX/Cw_Vnir_Matrix`, `KDP_AUX/Cw_Swir_Matrix`, `KDP_AUX/Cw_Fwhm_Matrix`, `KDP_AUX/Cw_Fwhm_Matrix` HDF layers. This could allow running different atmospheric corrections for different columns of the data, potentially allowing compensating
"smile" effects on the retrieved surface reflectances. For example, this code: 

```{r atcor2, eval=FALSE}
in_file  = "/home/lb/tmp/test/PRS_L1_STD_OFFL_20190825103112_20190825103117_0001.he5"
out_file = "/home/lb/tmp/test/test_1"
out_format = "ENVI"

# Save a full image, prioritizing the VNIR spectrometer and save in EVI format
convert_prisma(in_file    = in_file,
               out_file   = out_file,
               out_format = out_format,
               join_priority = "VNIR", 
               ATCOR = TRUE, 
               ATCOR_wls = c(200,800), 
               FULL = TRUE,
               PAN  = TRUE,
               CLOUD  = TRUE)

```

will create additional ATCOR imput files with wavelengths corresponding to those of the columns 200 and 800.


__IMPORTANT NOTE__

The latter functionality may be only appliable to "HRC" L1 data cubes. We are currently investigating this - proceed with caution!
